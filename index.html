<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>球体照片墙</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, "Microsoft YaHei", sans-serif;
            background-color: #020510;
            color: #fff;
        }
        
        #canvas-container {
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        #help-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.6);
            border: 1px solid #8090ff;
            border-radius: 8px;
            padding: 15px;
            color: #fff;
            font-size: 14px;
            max-width: 250px;
            opacity: 0.9;
            transition: opacity 0.3s;
            z-index: 100;
        }
        
        #help-panel h3 {
            margin-top: 0;
            color: #8090ff;
        }
        
        #help-panel ul {
            padding-left: 20px;
            margin-bottom: 5px;
        }
        
        #control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.6);
            border: 1px solid #8090ff;
            border-radius: 8px;
            padding: 15px;
            color: #fff;
            z-index: 100;
            display: none;
        }
        
        .control-btn {
            background-color: #213060;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 5px 0;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .control-btn:hover {
            background-color: #4050b0;
        }
        
        #title-container {
            position: fixed;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 50;
        }
        
        #main-title {
            font-size: 24px;
            font-weight: bold;
            color: #8090ff;
            text-shadow: 0 0 10px rgba(0, 0, 255, 0.5);
            margin: 0;
        }
        
        #subtitle {
            font-size: 16px;
            color: #6070df;
            margin-top: 5px;
        }
        
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #020510;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        #loading-progress {
            width: 300px;
            height: 10px;
            background-color: #213060;
            border-radius: 5px;
            margin-top: 20px;
            overflow: hidden;
        }
        
        #progress-bar {
            height: 100%;
            width: 0%;
            background-color: #8090ff;
            transition: width 0.3s;
        }
        
        /* 照片查看器样式 */
        #photo-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
            flex-direction: column;
        }
        
        #viewer-image {
            max-width: 80%;
            max-height: 80%;
            object-fit: contain;
            border: 3px solid #8090ff;
            box-shadow: 0 0 30px rgba(100, 150, 255, 0.6);
        }
        
        #viewer-close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 40px;
            color: #fff;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        #viewer-close:hover {
            color: #8090ff;
        }
        
        #viewer-title {
            margin-top: 15px;
            color: #8090ff;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <h2>正在加载球体照片墙</h2>
        <div id="loading-progress">
            <div id="progress-bar"></div>
        </div>
        <p id="loading-text">准备中...</p>
    </div>
    
    <div id="canvas-container"></div>
    
    <div id="title-container">
        <h1 id="main-title">球体照片墙</h1>
        <div id="subtitle">珍藏美好回忆</div>
    </div>
    
    <div id="help-panel">
        <h3>控制方式</h3>
        <ul>
            <li>鼠标拖动: 旋转查看</li>
            <li>滚轮: 缩放</li>
            <li>点击照片: 查看大图</li>
            <li>H: 显示/隐藏帮助</li>
            <li>C: 显示/隐藏控制面板</li>
            <li>R: 重置视图</li>
            <li>A: 开始/停止自动旋转</li>
            <li>L: 切换光照效果</li>
        </ul>
    </div>
    
    <div id="control-panel">
        <button class="control-btn" id="btn-auto-rotate">自动旋转</button>
        <button class="control-btn" id="btn-reset-view">重置视图</button>
        <button class="control-btn" id="btn-randomize">随机排列</button>
        <button class="control-btn" id="btn-toggle-light">切换光效</button>
        <button class="control-btn" id="btn-fullscreen">全屏显示</button>
    </div>
    
    <div id="photo-viewer">
        <div id="viewer-close">&times;</div>
        <img id="viewer-image" src="" alt="Photo">
        <div id="viewer-title"></div>
    </div>

    <!-- 导入Three.js库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r17/Stats.min.js"></script>
    
    <script>
        // 配置项
        const config = {
            radius: 250,             // 球体半径
            particleCount: 400,      // 粒子数量
            imageSize: 50,           // 基础图像大小
            enableParticles: true,   // 是否启用粒子
            autoRotateSpeed: 0.2,    // 自动旋转速度
            themeColor: new THREE.Color(0x80a0ff),  // 主题色
            bgColor: new THREE.Color(0x020510),     // 背景色
            mainTitle: "照片墙",  // 主标题
            subTitle: "动态更新点点滴滴", // 副标题
        };
        
        // 全局变量
        let scene, camera, renderer, controls;
        let photos = [];
        let particles = [];
        let photoGroup, particleGroup, orbitGroup;
        let autoRotate = false;
        let raycaster, mouse;
        let lightMode = 0;
        let lights = [];
        let stats;
        let isAnimating = false;
        
        // 预设图片路径 (用实际图片路径替换这些)
const demoImages = [
    "photos/photo1.jpg",
    "photos/photo2.jpg",
    "photos/photo3.jpg",
    "photos/photo4.jpg",
    "photos/photo5.jpg",
    "photos/photo6.jpg",
    "photos/photo7.jpg",
    "photos/photo8.jpg",
    "photos/photo9.jpg",
    "photos/photo10.jpg",
    "photos/photo11.jpg",
    "photos/photo12.jpg",
    "photos/photo13.jpg",
    "photos/photo14.jpg",
    "photos/photo15.jpg",
    "photos/photo16.jpg",
    "photos/photo17.jpg",
    "photos/photo18.jpg",
    "photos/photo19.jpg",
    "photos/photo20.jpg",
    "photos/photo21.jpg",
    "photos/photo22.jpg",
    "photos/photo23.jpg",
    "photos/photo24.jpg",
    "photos/photo25.jpg",
    "photos/photo26.jpg",
    "photos/photo27.jpg",
    "photos/photo28.jpg",
    "photos/photo29.jpg",
    "photos/photo30.jpg",
    "photos/photo31.jpg",
    "photos/photo32.jpg",
    "photos/photo33.jpg",
    "photos/photo34.jpg",
    "photos/photo35.jpg",
    "photos/photo36.jpg",
    "photos/photo37.jpg",
    "photos/photo38.jpg",
    "photos/photo39.jpg",
    "photos/photo40.jpg",
    "photos/photo41.jpg",
    "photos/photo42.jpg",
    "photos/photo43.jpg",
    "photos/photo44.jpg",
    "photos/photo45.jpg",
    "photos/photo46.jpg",
    "photos/photo47.jpg",
    "photos/photo48.jpg",
    "photos/photo49.jpg",
    "photos/photo50.jpg",
    "photos/photo51.jpg",
    "photos/photo52.jpg",
    "photos/photo53.jpg"
];
        
        // 初始化场景
        function init() {
            // 创建场景
            scene = new THREE.Scene();
            scene.background = config.bgColor;
            
            // 添加相机
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.z = config.radius * 2;
            
            // 创建渲染器
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            // 初始化射线器和鼠标坐标
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            
            // 添加灯光
            setupLights();
            
            // 创建组
            photoGroup = new THREE.Group();
            scene.add(photoGroup);
            
            particleGroup = new THREE.Group();
            scene.add(particleGroup);
            
            orbitGroup = new THREE.Group();
            scene.add(orbitGroup);
            
            // 添加性能监视器
            if (window.location.hash.includes('debug')) {
                stats = new Stats();
                stats.showPanel(0);
                document.body.appendChild(stats.dom);
            }
            
            // 添加装饰物
            addDecorations();
            
            // 添加事件监听器
            setupEventListeners();
            
            // 加载图片
            loadImages();
            
            // 渲染循环
            animate();
        }
        
        // 设置灯光
        function setupLights() {
            // 环境光
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);
            
            // 方向光1
            const light1 = new THREE.DirectionalLight(0xffffff, 0.7);
            light1.position.set(1, 1, 1);
            scene.add(light1);
            lights.push(light1);
            
            // 方向光2
            const light2 = new THREE.DirectionalLight(0xc9e0ff, 0.4);
            light2.position.set(-1, -1, 1);
            scene.add(light2);
            lights.push(light2);
            
            // 点光源
            const spotLight = new THREE.PointLight(config.themeColor, 1, 1000);
            spotLight.position.set(0, 0, 300);
            scene.add(spotLight);
            lights.push(spotLight);
        }
        
        // 添加装饰物
        function addDecorations() {
            // 添加半透明球体
            const sphereGeometry = new THREE.SphereGeometry(config.radius * 1.05, 32, 32);
            const sphereMaterial = new THREE.MeshBasicMaterial({
                color: config.themeColor,
                transparent: true,
                opacity: 0.1,
                side: THREE.BackSide
            });
            const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
            scene.add(sphere);
            
            // 添加粒子
            if (config.enableParticles) {
                const particleMaterial = new THREE.PointsMaterial({
                    color: config.themeColor,
                    size: 1.5,
                    transparent: true,
                    opacity: 0.8,
                    sizeAttenuation: true
                });
                
                const particleGeometry = new THREE.BufferGeometry();
                const particlePositions = [];
                
                for (let i = 0; i < config.particleCount; i++) {
                    // 生成距离中心2-3倍半径的随机位置
                    const radius = config.radius * (2 + Math.random());
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.random() * Math.PI;
                    
                    const x = radius * Math.sin(phi) * Math.cos(theta);
                    const y = radius * Math.sin(phi) * Math.sin(theta);
                    const z = radius * Math.cos(phi);
                    
                    particlePositions.push(x, y, z);
                }
                
                particleGeometry.setAttribute('position', new THREE.Float32BufferAttribute(particlePositions, 3));
                const particleSystem = new THREE.Points(particleGeometry, particleMaterial);
                particleGroup.add(particleSystem);
                particles.push(particleSystem);
            }
            
            // 添加轨道线
            const orbitCount = 3;
            for (let i = 0; i < orbitCount; i++) {
                const orbitRadius = config.radius * (1.1 + i * 0.1);
                const orbitGeometry = new THREE.BufferGeometry();
                const orbitVertices = [];
                
                // 创建一个倾斜的轨道
                const tilt = Math.random() * Math.PI / 6; // 最大倾斜30度
                const tiltDirection = Math.random() * Math.PI * 2;
                
                // 生成轨道点
                const segments = 100;
                for (let j = 0; j <= segments; j++) {
                    const theta = (j / segments) * Math.PI * 2;
                    
                    // 基础圆
                    let x = orbitRadius * Math.cos(theta);
                    let y = orbitRadius * Math.sin(theta);
                    let z = 0;
                    
                    // 应用倾斜
                    const newY = y * Math.cos(tilt) - z * Math.sin(tilt);
                    const newZ = y * Math.sin(tilt) + z * Math.cos(tilt);
                    y = newY;
                    z = newZ;
                    
                    // 应用旋转
                    const newX = x * Math.cos(tiltDirection) - y * Math.sin(tiltDirection);
                    const newY2 = x * Math.sin(tiltDirection) + y * Math.cos(tiltDirection);
                    x = newX;
                    y = newY2;
                    
                    orbitVertices.push(x, y, z);
                }
                
                orbitGeometry.setAttribute('position', new THREE.Float32BufferAttribute(orbitVertices, 3));
                
                // 创建轨道线
                const intensity = 0.7 + i * 0.1;
                const orbitMaterial = new THREE.LineBasicMaterial({ 
                    color: config.themeColor, 
                    transparent: true, 
                    opacity: 0.3 * intensity
                });
                
                const orbit = new THREE.Line(orbitGeometry, orbitMaterial);
                orbitGroup.add(orbit);
            }
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 鼠标拖动控制
            document.addEventListener('mousedown', onMouseDown);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            
            // 鼠标滚轮缩放
            document.addEventListener('wheel', onMouseWheel);
            
            // 鼠标点击
            document.addEventListener('click', onMouseClick);
            
            // 键盘控制
            document.addEventListener('keydown', onKeyDown);
            
            // 窗口大小调整
            window.addEventListener('resize', onWindowResize);
            
            // 控制面板按钮
            document.getElementById('btn-auto-rotate').addEventListener('click', toggleAutoRotate);
            document.getElementById('btn-reset-view').addEventListener('click', resetView);
            document.getElementById('btn-randomize').addEventListener('click', randomizePhotos);
            document.getElementById('btn-toggle-light').addEventListener('click', toggleLights);
            document.getElementById('btn-fullscreen').addEventListener('click', toggleFullscreen);
            
            // 照片查看器关闭按钮
            document.getElementById('viewer-close').addEventListener('click', closePhotoViewer);
        }
        
        // 加载图片
        function loadImages() {
            // 在实际应用中，应该从用户提供的文件夹或服务器获取图片列表
            // 这里使用演示图片列表
            
            const imageUrls = demoImages;
            
            // 模拟添加更多图片以达到50个左右
            const extendedUrls = [];
            while (extendedUrls.length < 50) {
                extendedUrls.push(...imageUrls);
            }
            
            // 截取需要的数量
            const finalUrls = extendedUrls.slice(0, 53);
            
            // 更新进度条最大值
            const totalImages = finalUrls.length;
            let loadedImages = 0;
            
            // 加载图片
            finalUrls.forEach((url, index) => {
                const loader = new THREE.TextureLoader();
                
                // 添加负载进度处理
                loader.load(
                    url,
                    (texture) => {
                        // 图片加载成功
                        createPhoto(texture, index, finalUrls.length);
                        
                        // 更新加载进度
                        loadedImages++;
                        const progress = (loadedImages / totalImages) * 100;
                        document.getElementById('progress-bar').style.width = progress + '%';
                        document.getElementById('loading-text').textContent = 
                            `正在加载 ${loadedImages}/${totalImages}`;
                        
                        // 检查是否所有图片都已加载
                        if (loadedImages === totalImages) {
                            // 隐藏加载屏幕
                            setTimeout(() => {
                                document.getElementById('loading-screen').style.display = 'none';
                            }, 500);
                        }
                    },
                    // 进度回调
                    (xhr) => {
                        // 可以使用xhr.loaded / xhr.total来显示每个文件的进度
                    },
                    // 错误回调
                    (error) => {
                        console.error('加载图片出错:', error);
                        
                        // 更新加载进度（即使出错）
                        loadedImages++;
                        const progress = (loadedImages / totalImages) * 100;
                        document.getElementById('progress-bar').style.width = progress + '%';
                    }
                );
            });
        }
        
        // 创建照片
        function createPhoto(texture, index, totalPhotos) {
            // 使用Fibonacci球面分布算法计算位置
            const phi = Math.acos(-1 + (2 * index) / totalPhotos);
            const theta = Math.sqrt(totalPhotos * Math.PI) * phi;
            
            // 添加随机扰动
            const randomFactor = 0.05;
            const randomOffset = new THREE.Vector3(
                (Math.random() - 0.5) * randomFactor,
                (Math.random() - 0.5) * randomFactor,
                (Math.random() - 0.5) * randomFactor
            );
            
            // 计算位置
            const x = Math.cos(theta) * Math.sin(phi);
            const y = Math.sin(theta) * Math.sin(phi);
            const z = Math.cos(phi);
            
            const position = new THREE.Vector3(
                config.radius * (x + randomOffset.x),
                config.radius * (y + randomOffset.y),
                config.radius * (z + randomOffset.z)
            );
            
            // 将位置归一化
            position.normalize().multiplyScalar(config.radius);
            
            // 计算平面法向量
            const normal = position.clone().normalize();
            
            // 创建正交向量
            let tangent;
            if (Math.abs(normal.x) < Math.abs(normal.y) && Math.abs(normal.x) < Math.abs(normal.z)) {
                tangent = new THREE.Vector3(0, -normal.z, normal.y);
            } else if (Math.abs(normal.y) < Math.abs(normal.z)) {
                tangent = new THREE.Vector3(-normal.z, 0, normal.x);
            } else {
                tangent = new THREE.Vector3(-normal.y, normal.x, 0);
            }
            tangent.normalize();
            
            const bitangent = new THREE.Vector3();
            bitangent.crossVectors(normal, tangent);
            
            // 根据图片尺寸调整平面大小
            const imageRatio = texture.image.width / texture.image.height;
            const photoWidth = config.imageSize * imageRatio;
            const photoHeight = config.imageSize;
            
            // 创建平面几何体
            const geometry = new THREE.PlaneGeometry(photoWidth, photoHeight);
            
            // 创建材质
            const material = new THREE.MeshBasicMaterial({
                map: texture,
                side: THREE.DoubleSide
            });
            
            // 创建网格
            const photo = new THREE.Mesh(geometry, material);
            
            // 定位到正确的位置和方向
            photo.position.copy(position);
            
            // 将平面朝向正确的方向
            const lookAtPosition = position.clone().add(normal);
            photo.lookAt(lookAtPosition);
            
            // 稍微随机旋转
            photo.rotateZ(Math.random() * Math.PI * 0.1);
            
            // 存储原始位置信息用于动画
            photo.userData = {
                originalPosition: position.clone(),
                normal: normal.clone(),
                index: index,
                imageName: `Photo ${index + 1}`,
                imageUrl: texture.image.src
            };
            
            // 添加照片边框
            const edgeGeometry = new THREE.EdgesGeometry(geometry);
            const edgeMaterial = new THREE.LineBasicMaterial({
                color: config.themeColor,
                transparent: true,
                opacity: 0.8
            });
            const edges = new THREE.LineSegments(edgeGeometry, edgeMaterial);
            photo.add(edges);
            
            // 添加到场景
            photoGroup.add(photo);
            photos.push(photo);
        }
        
        // 鼠标按下事件
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        
        function onMouseDown(event) {
            isDragging = true;
            previousMousePosition = {
                x: event.clientX,
                y: event.clientY
            };
        }
        
        function onMouseMove(event) {
            if (!isDragging) return;
            
            const deltaMove = {
                x: event.clientX - previousMousePosition.x,
                y: event.clientY - previousMousePosition.y
            };
            
            // 旋转场景
            const rotationSpeed = 0.005;
            photoGroup.rotation.y += deltaMove.x * rotationSpeed;
            photoGroup.rotation.x += deltaMove.y * rotationSpeed;
            
            // 同步其他元素旋转
            particleGroup.rotation.copy(photoGroup.rotation);
            orbitGroup.rotation.copy(photoGroup.rotation);
            
            previousMousePosition = {
                x: event.clientX,
                y: event.clientY
            };
        }
        
        function onMouseUp(event) {
            isDragging = false;
        }
        
        // 鼠标滚轮事件
        function onMouseWheel(event) {
            event.preventDefault();
            
            // 缩放相机
            const zoomSensitivity = 0.1;
            const delta = Math.sign(event.deltaY) * zoomSensitivity;
            
            // 更新相机位置
            const direction = new THREE.Vector3().subVectors(camera.position, new THREE.Vector3(0, 0, 0));
            const distance = direction.length();
            
            // 限制缩放范围
            const newDistance = Math.max(config.radius * 1.2, Math.min(config.radius * 4, distance * (1 + delta)));
            
            direction.normalize().multiplyScalar(newDistance);
            camera.position.copy(direction);
        }
        
        // 鼠标点击事件
        function onMouseClick(event) {
            // 通过射线检测判断点击了哪个照片
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            
            const intersects = raycaster.intersectObjects(photos);
            
            if (intersects.length > 0) {
                const photo = intersects[0].object;
                showPhotoViewer(photo);
            }
        }
        
        // 键盘事件
        function onKeyDown(event) {
            switch (event.key.toLowerCase()) {
                case 'h': // 显示/隐藏帮助
                    const helpPanel = document.getElementById('help-panel');
                    helpPanel.style.display = helpPanel.style.display === 'none' ? 'block' : 'none';
                    break;
                
                case 'c': // 显示/隐藏控制面板
                    const controlPanel = document.getElementById('control-panel');
                    controlPanel.style.display = controlPanel.style.display === 'none' ? 'block' : 'none';
                    break;
                
                case 'r': // 重置视图
                    resetView();
                    break;
                
                case 'a': // 切换自动旋转
                    toggleAutoRotate();
                    break;
                
                case 'l': // 切换灯光
                    toggleLights();
                    break;
                
                case 'f': // 全屏
                    toggleFullscreen();
                    break;
            }
        }
        
        // 窗口大小改变事件
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // 显示照片查看器
        function showPhotoViewer(photo) {
            const viewer = document.getElementById('photo-viewer');
            const viewerImage = document.getElementById('viewer-image');
            const viewerTitle = document.getElementById('viewer-title');
            
            viewerImage.src = photo.userData.imageUrl;
            viewerTitle.textContent = photo.userData.imageName;
            
            viewer.style.display = 'flex';
        }
        
        // 关闭照片查看器
        function closePhotoViewer() {
            const viewer = document.getElementById('photo-viewer');
            viewer.style.display = 'none';
        }
        
        // 切换自动旋转
        function toggleAutoRotate() {
            autoRotate = !autoRotate;
            
            // 更新按钮文字
            const button = document.getElementById('btn-auto-rotate');
            button.textContent = autoRotate ? '停止旋转' : '自动旋转';
        }
        
        // 重置视图
        function resetView() {
            // 使用TWEEN创建平滑动画
            const targetRotation = { x: 0, y: 0, z: 0 };
            const currentRotation = { 
                x: photoGroup.rotation.x, 
                y: photoGroup.rotation.y, 
                z: photoGroup.rotation.z 
            };
            
            new TWEEN.Tween(currentRotation)
                .to(targetRotation, 1000)
                .easing(TWEEN.Easing.Quadratic.Out)
                .onUpdate(() => {
                    photoGroup.rotation.x = currentRotation.x;
                    photoGroup.rotation.y = currentRotation.y;
                    photoGroup.rotation.z = currentRotation.z;
                    
                    particleGroup.rotation.copy(photoGroup.rotation);
                    orbitGroup.rotation.copy(photoGroup.rotation);
                })
                .start();
                
            // 重置相机位置
            const currentCamPosition = camera.position.clone();
            const targetCamPosition = new THREE.Vector3(0, 0, config.radius * 2);
            
            new TWEEN.Tween(currentCamPosition)
                .to(targetCamPosition, 1000)
                .easing(TWEEN.Easing.Quadratic.Out)
                .onUpdate(() => {
                    camera.position.copy(currentCamPosition);
                })
                .start();
        }
        
        // 随机排列照片
        function randomizePhotos() {
            if (isAnimating) return;
            isAnimating = true;
            
            photos.forEach(photo => {
                // 生成新的随机位置
                const phi = Math.acos(-1 + 2 * Math.random());
                const theta = Math.sqrt(photos.length * Math.PI) * phi;
                
                const x = Math.cos(theta) * Math.sin(phi);
                const y = Math.sin(theta) * Math.sin(phi);
                const z = Math.cos(phi);
                
                const newPosition = new THREE.Vector3(
                    config.radius * x,
                    config.radius * y,
                    config.radius * z
                );
                
                // 为了保持朝向，需要计算新的方向
                const newNormal = newPosition.clone().normalize();
                
                // 动画到新位置
                new TWEEN.Tween(photo.position)
                    .to(newPosition, 2000)
                    .easing(TWEEN.Easing.Cubic.InOut)
                    .onUpdate(() => {
                        // 更新朝向
                        const lookAtPosition = photo.position.clone().add(newNormal);
                        photo.lookAt(lookAtPosition);
                    })
                    .start();
                
                // 更新userData中的位置信息
                photo.userData.originalPosition = newPosition;
                photo.userData.normal = newNormal;
            });
            
            // 设置动画完成标记
            setTimeout(() => {
                isAnimating = false;
            }, 2000);
        }
        
        // 切换灯光效果
        function toggleLights() {
            lightMode = (lightMode + 1) % 3;
            
            switch (lightMode) {
                case 0: // 默认灯光
                    lights[0].color.set(0xffffff);
                    lights[1].color.set(0xc9e0ff);
                    lights[2].color.set(config.themeColor);
                    break;
                
                case 1: // 暖色调
                    lights[0].color.set(0xffeda3);
                    lights[1].color.set(0xffb769);
                    lights[2].color.set(0xff8a54);
                    break;
                
                case 2: // 冷色调
                    lights[0].color.set(0xa3d9ff);
                    lights[1].color.set(0x69c5ff);
                    lights[2].color.set(0x548fff);
                    break;
            }
        }
        
        // 切换全屏
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        
        // 动画循环
        function animate() {
            requestAnimationFrame(animate);
            
            if (stats) stats.begin();
            
            // 更新TWEEN
            TWEEN.update();
            
            // 自动旋转
            if (autoRotate) {
                photoGroup.rotation.y += config.autoRotateSpeed * 0.01;
                particleGroup.rotation.copy(photoGroup.rotation);
                orbitGroup.rotation.copy(photoGroup.rotation);
            }
            
            // 更新粒子闪烁
            if (config.enableParticles && particles.length > 0) {
                const positions = particles[0].geometry.attributes.position.array;
                for (let i = 0; i < positions.length; i += 3) {
                    if (Math.random() < 0.002) { // 偶尔改变一些粒子的位置
                        const radius = config.radius * (2 + Math.random() * 0.5);
                        const theta = Math.random() * Math.PI * 2;
                        const phi = Math.random() * Math.PI;
                        
                        positions[i] = radius * Math.sin(phi) * Math.cos(theta);
                        positions[i+1] = radius * Math.sin(phi) * Math.sin(theta);
                        positions[i+2] = radius * Math.cos(phi);
                    }
                }
                particles[0].geometry.attributes.position.needsUpdate = true;
            }
            
            // 更新点光源位置
            if (lights[2]) {
                const time = Date.now() * 0.0005;
                lights[2].position.x = Math.sin(time * 1.1) * config.radius * 1.5;
                lights[2].position.y = Math.cos(time * 1.3) * config.radius * 1.5;
                lights[2].position.z = Math.sin(time * 1.5) * config.radius + config.radius * 1.5;
            }
            
            // 渲染场景
            renderer.render(scene, camera);
            
            if (stats) stats.end();
        }
        
        // 设置自定义标题和副标题
        function setTitles(mainTitle, subTitle) {
            if (mainTitle) {
                document.getElementById('main-title').textContent = mainTitle;
                config.mainTitle = mainTitle;
            }
            
            if (subTitle) {
                document.getElementById('subtitle').textContent = subTitle;
                config.subTitle = subTitle;
            }
        }
        
        // 加载本地图片
        function handleLocalImages(fileList) {
            // 清空现有照片
            photos.forEach(photo => {
                photoGroup.remove(photo);
            });
            photos = [];
            
            const files = Array.from(fileList);
            const totalFiles = files.length;
            let loadedFiles = 0;
            
            // 显示加载屏幕
            document.getElementById('loading-screen').style.display = 'flex';
            document.getElementById('loading-text').textContent = '准备加载...';
            document.getElementById('progress-bar').style.width = '0%';
            
            // 逐个加载图片
            files.forEach((file, index) => {
                if (!file.type.match('image.*')) {
                    loadedFiles++;
                    updateLoadingProgress(loadedFiles, totalFiles);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    // 创建图片元素来获取尺寸
                    const img = new Image();
                    img.onload = function() {
                        // 创建纹理
                        const texture = new THREE.Texture(img);
                        texture.needsUpdate = true;
                        
                        // 创建照片
                        createPhoto(texture, index, totalFiles);
                        
                        // 更新进度
                        loadedFiles++;
                        updateLoadingProgress(loadedFiles, totalFiles);
                        
                        // 检查是否所有文件都已加载
                        if (loadedFiles === totalFiles) {
                            // 隐藏加载屏幕
                            setTimeout(() => {
                                document.getElementById('loading-screen').style.display = 'none';
                            }, 500);
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        function updateLoadingProgress(loaded, total) {
            const progress = (loaded / total) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('loading-text').textContent = 
                `正在加载 ${loaded}/${total}`;
        }
        
        // 添加拖放文件功能
        function setupFileDrop() {
            const dropArea = document.body;
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.classList.add('highlight');
            }
            
            function unhighlight() {
                dropArea.classList.remove('highlight');
            }
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                handleLocalImages(files);
            }
        }
        
        // 当页面加载完成后初始化
        window.onload = function() {
            init();
            setupFileDrop();
            
            // 设置自定义标题
            setTitles(config.mainTitle, config.subTitle);
        };
    </script>
</body>
</html>
